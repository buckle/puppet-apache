# file managed by puppet
<VirtualHost<% ports.each do |port| -%> <%= port %><% end -%>>
  ServerName <%= name %>

<% aliases.each do |serveralias| -%>
  ServerAlias <%= serveralias %>
<% end -%>

  DocumentRoot <%= documentroot %>

  LogLevel warn

  ServerSignature Off

  ErrorLog <%= wwwroot %>/<%= name %>/logs/error.log
  CustomLog <%= wwwroot %>/<%= name %>/logs/access.log "<%= accesslog_format %>"


<% if cgipath -%>
  ScriptAlias /cgi-bin/ <%= cgipath %>
  <Directory <%= cgipath %>>
    Options +ExecCGI
    AddHandler cgi-script .cgi
  </Directory>
<% end -%>


  <Directory "<%= documentroot %>">
    Order allow,deny
    Allow from all

    #Disable ETags, which breaks caching when using multiple webheads
    FileETag None

    ExpiresActive On
    <FilesMatch ".*_v13?_m\d+\..*$">
      #Any BlueMartini versioned file can be cached forever
      ExpiresDefault "access plus 10 years"
    </FilesMatch>
    <FilesMatch ".*_\d{2}-\d{2}-20\d{2}\..*$">
      #Any Buckle versioned file can be cached forever
      ExpiresDefault "access plus 10 years"
    </FilesMatch>
    <FilesMatch "ssl_test.*gif$">
      #Never allow our ssl tracking gif to be cached
      ExpiresDefault A0
      Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
      Header set Pragma "no-cache"
    </FilesMatch>

    #If the file is an image:
    #  don't gzip since it's already compressed,
    #  don't vary so proxies can serve the one local copy to any UA,
    #  set proxyokay env var which will later allow proxies to cache via Cache-Control
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary proxyokay

  </Directory>

  <Directory "<%= documentroot %>/css">
    ExpiresDefault "access plus 1 day"
  </Directory>
  <Directory "<%= documentroot %>/js">
    ExpiresDefault "access plus 1 day"
  </Directory>
  <Directory "<%= documentroot %>/media">
    ExpiresDefault "access plus 1 day"
  </Directory>

  <DirectoryMatch "^<%= documentroot %>/min-[a-f0-9]+">
    #Any jawr versioned file can be cached forever
    ExpiresDefault "access plus 10 years"
  </DirectoryMatch>

  DirectoryIndex index.jsp

  RewriteMap toupper int:toupper
  RewriteMap unescape int:unescape

  Include <%= wwwroot %>/<%= name%>/conf/*.conf

</VirtualHost>
